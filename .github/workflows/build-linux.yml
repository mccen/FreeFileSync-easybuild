name: Build FreeFileSync for Ubuntu 22.04

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            g++-12 \
            libssl-dev \
            libpsl-dev \
            libidn2-dev \
            libssh2-1-dev \
            libcurl4-openssl-dev \
            libboost-all-dev \
            libgtk2.0-dev \
            libglib2.0-dev \
            libsm-dev \
            zlib1g-dev

      - name: Build wxWidgets 3.3.1 (static, GTK2, no exceptions)
        run: |
          wget https://github.com/wxWidgets/wxWidgets/releases/download/v3.3.1/wxWidgets-3.3.1.tar.bz2
          tar xf wxWidgets-3.3.1.tar.bz2
          cd wxWidgets-3.3.1
          mkdir build-gtk
          cd build-gtk
          ../configure --disable-shared --disable-exceptions --with-gtk=2
          make -j"$(nproc)"
          sudo make install
          sudo ldconfig

      - name: Patch FreeFileSync sources (disable aggressive DPI check)
        working-directory: FreeFileSync/Source
        run: |
          # 在 wx+/dc.h 里强行定义 wxHAS_DPI_INDEPENDENT_PIXELS，绕过 #error
          sed -i 's/#include <wx\/dcscreen.h>/#include <wx\/dcscreen.h>\n#define wxHAS_DPI_INDEPENDENT_PIXELS 1/' wx+/dc.h

      - name: Build FreeFileSync
        working-directory: FreeFileSync/Source
        env:
          CXX: g++-12
        run: |
          make -j"$(nproc)"
          echo "Build output:"
          ls -R ../Build || true

      - name: Upload Linux binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: FreeFileSync-linux
          path: FreeFileSync/Build/Bin
